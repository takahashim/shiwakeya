# ユーザー権限管理システム

## 概要

仕訳屋（Shiwakeya）では、3段階のユーザーロールによる権限管理システムを実装しています。各ユーザーは役割に応じて異なるレベルのアクセス権限を持ちます。

## ユーザーロール

### 1. 管理者（Admin）

**役割**: システム全体の管理者

**権限**:
- 全てのスプレッドシートへのアクセス
- 全てのスプレッドシートの閲覧・編集・削除
- 新規スプレッドシートの登録
- ユーザー権限の管理
- 他のユーザーのロール変更
- メンバーへのスプレッドシート権限付与・削除

**初回設定**:
- 環境変数 `ADMIN_EMAIL` に設定されたメールアドレスで初回ログインしたユーザーは自動的に管理者になります

### 2. 会計担当者（Accountant）

役割: 会計業務の担当者

権限:
- 全てのスプレッドシートへのアクセス
- 全てのスプレッドシートの閲覧・編集
- シートデータの同期・更新・追加
- NG: 新規スプレッドシートの登録
- NG: スプレッドシートの削除
- NG: ユーザー権限の管理

**用途**:
- 経理部門のスタッフなど、全てのデータにアクセスが必要だが、システム管理は不要なユーザー向け

### 3. メンバー（Member）

役割: 一般ユーザー

権限:

- 許可されたスプレッドシートのみアクセス可能
- 許可されたスプレッドシートの閲覧
- 編集権限が付与されている場合のみ編集可能
- NG: 全スプレッドシート一覧の表示
- NG: 新規スプレッドシートの登録
- NG: スプレッドシートの削除
- NG: ユーザー権限の管理

**権限付与**:
- 管理者がユーザー権限管理画面から個別にスプレッドシートへのアクセス権限を付与
- スプレッドシートごとに「閲覧のみ」または「編集可能」を選択可能

## 権限の階層

```
管理者（Admin）
    ├── システム管理権限
    ├── ユーザー管理権限
    └── 全データアクセス権限

会計担当者（Accountant）
    └── 全データアクセス権限

メンバー（Member）
    └── 個別付与されたデータアクセス権限
```

## 権限チェックの実装

### コントローラーレベル

```ruby
# 管理者のみアクセス可能
before_action :require_admin

# 管理者または会計担当者のみアクセス可能
before_action :require_admin_or_accountant

# スプレッドシートへのアクセス権限チェック
before_action :check_spreadsheet_access

# スプレッドシートの編集権限チェック
before_action :check_spreadsheet_edit_permission
```

### モデルレベル

各ユーザーモデルには以下のメソッドが実装されています。

- `admin?` - 管理者かどうか
- `accountant?` - 会計担当者かどうか
- `member?` - メンバーかどうか
- `can_access_spreadsheet?(spreadsheet)` - スプレッドシートへのアクセス権限があるか
- `can_edit_spreadsheet?(spreadsheet)` - スプレッドシートの編集権限があるか
- `accessible_spreadsheets` - アクセス可能なスプレッドシート一覧

## データベース構造

### users テーブル
- `role` (string): 'admin', 'accountant', 'member' のいずれか

### user_spreadsheet_permissions テーブル
- `user_id` (integer): ユーザーID
- `service_spreadsheet_id` (integer): スプレッドシートID
- `can_edit` (boolean): 編集権限フラグ（デフォルト: false）
