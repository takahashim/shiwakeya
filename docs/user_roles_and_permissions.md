# ユーザー権限管理システム

## 概要

仕訳屋（Shiwakeya）では、3段階のユーザーロールによる権限管理システムを実装しています。各ユーザーは役割に応じて異なるレベルのアクセス権限を持ちます。

## ユーザーロール

### 1. 管理者（Admin）

**役割**: システム全体の管理者

**権限**:
- ✅ 全てのスプレッドシートへの無制限アクセス
- ✅ 全てのスプレッドシートの閲覧・編集・削除
- ✅ 新規スプレッドシートの登録
- ✅ ユーザー権限の管理
- ✅ 他のユーザーのロール変更
- ✅ メンバーへのスプレッドシート権限付与・削除

**初回設定**:
- 環境変数 `ADMIN_EMAIL` に設定されたメールアドレスで初回ログインしたユーザーは自動的に管理者になります

### 2. 会計担当者（Accountant）

**役割**: 会計業務の担当者

**権限**:
- ✅ 全てのスプレッドシートへのアクセス
- ✅ 全てのスプレッドシートの閲覧・編集
- ✅ シートデータの同期・更新・追加
- ❌ 新規スプレッドシートの登録（管理者のみ）
- ❌ スプレッドシートの削除（管理者のみ）
- ❌ ユーザー権限の管理（管理者のみ）

**用途**:
- 経理部門のスタッフなど、全てのデータにアクセスが必要だが、システム管理は不要なユーザー向け

### 3. メンバー（Member）

**役割**: 一般ユーザー

**権限**:
- ✅ 許可されたスプレッドシートのみアクセス可能
- ✅ 許可されたスプレッドシートの閲覧
- ✅ 編集権限が付与されている場合のみ編集可能
- ❌ 全スプレッドシート一覧の表示（許可されたもののみ表示）
- ❌ 新規スプレッドシートの登録
- ❌ スプレッドシートの削除
- ❌ ユーザー権限の管理

**権限付与**:
- 管理者がユーザー権限管理画面から個別にスプレッドシートへのアクセス権限を付与
- スプレッドシートごとに「閲覧のみ」または「編集可能」を選択可能

## 権限の階層

```
管理者（Admin）
    ├── システム管理権限
    ├── ユーザー管理権限
    └── 全データアクセス権限
        
会計担当者（Accountant）
    └── 全データアクセス権限
        
メンバー（Member）
    └── 個別付与されたデータアクセス権限
```

## 権限チェックの実装

### コントローラーレベル

```ruby
# 管理者のみアクセス可能
before_action :require_admin

# 管理者または会計担当者のみアクセス可能
before_action :require_admin_or_accountant

# スプレッドシートへのアクセス権限チェック
before_action :check_spreadsheet_access

# スプレッドシートの編集権限チェック
before_action :check_spreadsheet_edit_permission
```

### モデルレベル

各ユーザーモデルには以下のメソッドが実装されています：

- `admin?` - 管理者かどうか
- `accountant?` - 会計担当者かどうか
- `member?` - メンバーかどうか
- `can_access_spreadsheet?(spreadsheet)` - スプレッドシートへのアクセス権限があるか
- `can_edit_spreadsheet?(spreadsheet)` - スプレッドシートの編集権限があるか
- `accessible_spreadsheets` - アクセス可能なスプレッドシート一覧

## データベース構造

### users テーブル
- `role` (string): 'admin', 'accountant', 'member' のいずれか
- デフォルト値: 'member'

### user_spreadsheet_permissions テーブル
- `user_id` (integer): ユーザーID
- `service_spreadsheet_id` (integer): スプレッドシートID
- `can_edit` (boolean): 編集権限フラグ（デフォルト: false）
- ユニーク制約: user_id と service_spreadsheet_id の組み合わせ

## 権限管理画面

### アクセス方法
1. 管理者アカウントでログイン
2. ナビゲーションバーの「ユーザー権限」をクリック

### 機能
- **ユーザー一覧表示**: 全ユーザーのメールアドレス、名前、役割、アクセス可能シート数を表示
- **権限編集**: 各ユーザーの役割変更、スプレッドシートアクセス権限の個別設定
- **一括権限変更**: ユーザーの役割を変更すると、自動的に権限が更新される

## セキュリティ考慮事項

1. **最小権限の原則**: デフォルトでは全ユーザーが「メンバー」として作成され、必要最小限の権限のみ付与
2. **明示的な権限付与**: メンバーは明示的に権限を付与されたスプレッドシートのみアクセス可能
3. **権限の継承なし**: 上位権限（管理者、会計担当者）から下位への自動的な権限継承はなし
4. **監査ログ**: 将来的に権限変更の履歴を記録する機能を追加予定

## 運用ガイドライン

### 新規ユーザー追加時
1. ユーザーが初回ログイン時に自動的に「メンバー」として登録
2. 必要に応じて管理者が権限を昇格または個別のスプレッドシート権限を付与

### 権限変更時の注意点
- 管理者から他の役割への変更は、システム管理機能へのアクセスを失うため慎重に行う
- 会計担当者からメンバーへの変更は、全スプレッドシートへのアクセスを失うため事前に確認
- メンバーの個別権限は役割変更後も保持される

### 推奨される権限設定
- **管理者**: 1-2名の責任者のみ
- **会計担当者**: 経理部門の正社員
- **メンバー**: その他の一般スタッフ、部門担当者

## トラブルシューティング

### Q: ユーザーがスプレッドシートにアクセスできない
A: 以下を確認してください：
1. ユーザーの役割が正しく設定されているか
2. メンバーの場合、該当スプレッドシートへの権限が付与されているか
3. スプレッドシート自体が有効（is_active）になっているか

### Q: 編集ボタンが表示されない
A: 以下を確認してください：
1. ユーザーが管理者または会計担当者であるか
2. メンバーの場合、「編集可能」権限が付与されているか

### Q: 管理者アカウントを追加したい
A: 既存の管理者アカウントでログインし、ユーザー権限管理画面から他のユーザーを管理者に昇格させてください

## 今後の拡張予定

- [ ] 部門/グループ単位での権限管理
- [ ] 権限変更の承認ワークフロー
- [ ] 権限変更履歴の記録と監査ログ
- [ ] 期限付き権限の設定
- [ ] より細かい操作単位での権限制御（読み取り専用、コメントのみ等）